@{layout('')}

<!DOCTYPE html>
<html>
<head>
	<title>@{config.name}</title>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=11" />
	<meta name="format-detection" content="telephone=no" />
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
	<meta name="robots" content="noindex, nofollow" />
	<link rel="apple-touch-icon" href="/img/system.png" type="image/png" />
	<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,200,700" />
	<link rel="stylesheet" href="//cdn.totaljs.com/spa.min.css" />
	<script src="https://cdn.totaljs.com/spa.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.min.js"></script>
	@{import('meta', 'head', 'default.css', 'default.js', 'favicon.ico')}
</head>
<body data-jc="exec,binder">

	<div data-jc="message" data-button="@(Close)"></div>
	<div data-jc="confirm"></div>
	<div data-jc="audio" data-jc-path="user.volume"></div>
	<div data-jc="loading" class="ui-loading"></div>
	<div id="success"><span class="fa fa-check-circle"></span></div>

	<header>
		<div class="logo"><img src="/img/logo.svg" border="0" alt="@{config.name}" /></div>
		<img src="/img/empty.png" class="user-photo" />
		<div class="usermenu">
			<a href="/logoff/"><i class="fa fa-power-off"></i></a>
		</div>
		<a href="/account/" class="user jR">@{user.alias}</a>
		<nav class="menu">
			<a href="/" class="jR">@(Dashboard)</a>
			<a href="/account/" class="jR">@(My account)</a>
			@{if user.superadmin}
			<a href="/settings/applications/" class="jR">@(Applications)</a>
			<a href="/settings/users/" class="jR">@(Users)</a>
			<a href="/settings/" class="jR"><i class="fa fa-cogs"></i>@(Settings)</a>
			@{fi}
		</nav>
	</header>

	<div data-jc="page" data-jc-path="common.page" data-if="dashboard" class="hidden" data-template="/templates/dashboard.html"></div>
	<div data-jc="page" data-jc-path="common.page" data-if="account" class="hidden" data-template="/templates/account.html" data-reload="account_refresh"></div>

	@{if user.superadmin}
	<div data-jc="page" data-jc-path="common.page" data-if="applications" class="hidden" data-template="/templates/applications.html"></div>
	<div data-jc="page" data-jc-path="common.page" data-if="users" class="hidden" data-template="/templates/users.html"></div>
	<div data-jc="page" data-jc-path="common.page" data-if="settings" class="hidden" data-template="/templates/settings.html" data-reload="settings_refresh"></div>
	@{fi}

	<div id="bottom"></div>

	<script>

		Chart.defaults.global.legend.display = false;

		var common = {};
		common.datetime = new Date();
		common.name = '@{config.name}';
		common.url = '@{config.url}';
		common.version = '@{config.version}';
		common.language = '@{language}';
		common.languages = '@{config.languages}'.split(';');
		common.forms = {};
		common.page = '';
		common.form = '';
		common.isfocused = true;

		$(window).on('focus blur', function(e) {
			common.isfocused = e.type === 'focus';
		});

		var user = JSON.parse('@{json(user.readonly())}');
		$('.user-photo').attr('src', user.photo);

		// Routing
		ROUTE('/', function() {
			SET('common.page', 'dashboard');
		});

		ROUTE('/settings/applications/', function() {
			SET('common.page', 'applications');
		});

		ROUTE('/settings/users/', function() {
			SET('common.page', 'users');
		});

		ROUTE('/settings/', function() {
			SET('common.page', 'settings');
		});

		ROUTE('/account/', function() {
			SET('common.page', 'account');
		});

		// Important: this helper is here for localization
		// The JavaScript below contains bad code because the code contains Total.js localization elements (but it works when)
		Tangular.register('time', function(value) {
			var diff = Date.now() - value.parseDate().getTime();
			var minutes = ((diff / 1000) / 60) >> 0;

			if (minutes < 60) {
				if (minutes < 3)
					return '@(now)';
				return @(minutes + ' minutes ago');
			}

			var hours = (minutes / 60) >> 0;
			if (hours < 24)
				return @(hours + ' ' + Tangular.helpers.pluralize(hours, 'hours', 'hour', 'hours', 'hours') + ' ago');

			var days = (hours / 24) >> 0;
			if (days < 30)
				return @(days + ' ' + Tangular.helpers.pluralize(days, 'days', 'day', 'days', 'days') + ' ago');

			var months = (days / 29) >> 0;
			if (months < 12)
				return @(months + ' ' + Tangular.helpers.pluralize(months, 'months', 'month', 'months', 'months') + ' ago');

			var years = (month / 12) >> 0;
			return @(years + ' ' + Tangular.helpers.pluralize(years, 'years', 'year', 'years', 'years') + ' ago');
		});
	</script>


</body>
</html>