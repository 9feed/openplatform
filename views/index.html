@{layout('')}
@{title(config.name)}

<!DOCTYPE html>
<html class="noscroll">
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=10" />
	<meta name="format-detection" content="telephone=no" />
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
	<meta name="robots" content="all,follow" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-title" content="@{'%name'}" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<link rel="apple-touch-icon" href="/icon.png" />
	<link rel="manifest" href="/manifest.json" />
	<link rel="stylesheet" href="@{'%cdn'}/spa.min@17.css" />
	@{if user && (user.background || CONF.background)}
	<style>body{background:url(/backgrounds/@{user.background || CONF.background}) 50% 50%}</style>
	@{fi}
	<script src="@{'%cdn'}/spa.min@17.js"></script>
	@{import('meta', 'head', 'default.css', 'default.js', 'favicon.ico')}
	<script>var user = EMPTYOBJECT</script>
</head>
<body data---="exec" class="noscroll @{if user.darkmode}ui-dark@{else}light@{fi}">

	<div data---="LAZY features__null__placeholder:@(What are you looking for?)"></div>
	<div data---="LAZY contextmenu"></div>
	<div data---="LAZY confirm"></div>
	<div data---="LAZY snackbar__null__button:@(OK);timeout:6000"></div>
	<div data---="LAZY contextmenu"></div>
	<div data---="LAZY calendar"></div>
	<div data---="LAZY message__null__button:@(Close)"></div>
	<div data---="LAZY menu"></div>
	<div data---="audio__user.volume"></div>
	<div data---="loading" class="hidden"></div>
	<div data---="shortcuts"></div>

	<footer>
		<div class="testmode hidden" data-bind="user.test__show__delay:200">@(TEST)</div>
		<div class="console" data-bind="common.consolecount__html span:value__click:Dashboard/showconsole"><i class="fa fa-clipboard-list"></i><span>0</span></div>
		<div class="username hidden" data-bind="user__html span:value.name__show:value.name__click:Dashboard/showprofile"><i class="fa fa-user-circle"></i><span></span></div>
		<div class="status hidden" data-bind="common.status__show__exec:renderstatus"></div>
	</footer>

	<header data-bind="user__.header-show:value && value.name">

		<div class="button-status exec" data-exec="Dashboard/showstatusform" data-bind="user.statusid__html:Thelpers.status(value, true)__|__common.statusid__.button-status-warning:value==null"></div>
		<div class="datetime hidden-xs" data---="time"></div>

		<div class="user exec" data-exec="mainmenu" data-bind="common.startmenu__.selected:value">
			<i class="fa fa-th"></i>
		</div>

		<div class="nav">
			<div>
				<nav data---="repeater__dashboard.apps__$setter:Dashboard/resizeapps" id="dashboardapps">
					<script type="text/html">
						<button title="{{ internal.title }}" class="exec appprocess" data-exec="Dashboard/open" data-id="{{ id }}"><b class="appbadge{{ if !internal.countbadges }} hidden{{ fi }}" data-id="{{ id }}"><i class="fa fa-circle"></i></b><i class="fa fa-{{ internal.icon }}"></i><span class="appprogress ap{{ id }}"><span class="userbg"></span></span></button>
					</script>
				</nav>
			</div>
		</div>
		<div class="button-notifications exec" data-path="common.notifications" data-value="!common.notifications">
			<span data-bind="user.countnotifications__show:value > 0__html:value > 99 ? 99 : value" class="hidden">0</span>
			<i class="far fa-bell" data-bind="common.notifications__.fa:!!value__.far:!value"></i>
		</div>
	</header>

	<div data---="notifications__common.notifications" data-bind="common.notifications__show:value" class="hidden">
		<div class="ui-notifications-clear hidden"><i class="fa fa-trash"></i>@(Remove all notifications)</div>
		<script type="text/html">
			<div class="ui-notifications-message{{ if type === 1 }} ui-notifications-success{{ else if type === 2 }} ui-notifications-error{{ fi }}">
				<div class="ui-notifications-date"><i class="fa fa-clock-o"></i>{{ datecreated | format('yyyy-MM-dd HH:mm') }}</div>
				<div class="ui-notifications-title"><i class="fa fa-{{ icon }}"></i><b>{{ title }}</b></div>
				<div class="ui-notifications-padding">
					<div class="ui-notifications-body">{{ body | markdown_notifications }}</div>
					{{ if data }}
					<button data-data="{{ data | encodedata }}" data-id="{{ appid }}" class="exec" data-exec="Dashboard/navigate">@(OPEN)</button>
					{{ fi }}
				</div>
			</div>
		</script>
	</div>

	<div data---="wiki__common.wikishow__datasource:common.wiki"></div>
	<div data---="processes__dashboard.current__datasource:dashboard.apps;options:Dashboard/appmenu"></div>

	<div class="startmenu hidden" data-bind="common.startmenu__exec:togglemenu">
		<div class="startmenu-nav" data---="xs__common.startmenuapps__if:!value">
			<div>
				<nav>
					@{if user.sa}
					<button class="exec internal" data-exec="internalapp" data-id="_users"><i class="fa fa-users"></i>@(Users)</button>
						@{if !user.directory}
						<button class="exec internal" data-exec="internalapp" data-id="_apps"><i class="fa fa-rocket"></i>@(Apps)</button>
						<button class="exec internal" data-exec="internalapp" data-id="_settings"><i class="fa fa-cogs"></i>@(Settings)</button>
						<button class="exec internal" data-exec="internalapp" data-id="_info"><i class="fa fa-question-circle"></i>@(About)</button>
						@{fi}
					@{fi}
					<button class="exec internal" data-exec="internalapp" data-id="_account"><i class="fa fa-user-circle"></i>@(My account)</button>
					<button class="exec internal" data-exec="Dashboard/showsessions"><i class="fa fa-history"></i>@(My sessions)</button>
					<button class="exec hidden-xs" data-exec="internalreset"><i class="fa fa-window-restore"></i>@(Reset windows)</button>
					<button class="exec" data-exec="internallogoff"><i class="fa fa-power-off red"></i>@(Sign out)</button>
				</nav>
			</div>
		</div>
		<div class="startmenu-apps">
			<div class="startmenu-search">
				<div data---="textbox__common.startmenusearch__type:search;placeholder:@(Search apps)"></div>
			</div>
			<div data---="search__common.startmenusearch__selector:.app" class="startmenu-apps-container">
				<div class="noscrollbar">
					<div data---="repeater__user.apps__if:!value.internal">
						<script type="text/html">
							<div class="app{{ if !online }} app-offline{{ fi }}{{ responsive | responsive }}" data-id="{{ id }}" data-search="{{ title }}">
								<span><i class="fa fa-power-off"></i>@(OFFLINE)</span>
								<i class="far fa-bell-slash appnonotify{{ if !mutenotifications }} hidden{{ fi }}" data-id="{{ id }}"></i>
								<i class="appclose fa fa-times {{ if !running }}hidden {{ fi }}exec" data-exec="Dashboard/close" data-id="{{ id }}"></i>
								<b class="appunread{{ if !countnotifications }} hidden{{ fi }}" data-id="{{ id }}">{{ countnotifications }}</b>
								<b class="appbadge{{ if !countbadges }} hidden{{ fi }}" data-id="{{ id }}"><i class="fa fa-circle"></i></b>
								<div class="app-container">
									<div class="app-icon"><i class="fa fa-{{ icon }}"></i></div>
									<div class="app-meta">{{ title }}</div>
								</div>
							</div>
						</script>
					</div>
				</div>
			</div>
		</div>
		<div class="clearfix"></div>
		<div class="startmenu-title">
			<div class="startmenu-status exec" data-exec="Dashboard/showstatusform" data-bind="user__html b:Thelpers.status(value.statusid)__text span:value.status || '@(You can specify your status)'"><b></b><span></span></div>
			<button class="exec" data-path="common.startmenuapps" data-value="!value"><i class="fa fa-ellipsis-h"></i></button>
			<div class="startmenu-profile exec" data-exec="Dashboard/showprofile">
				<img src="/img/face.jpg" data-bind="user.photo__src:Tangular.helpers.photo(value)" onerror="onImageError(this)" />
				<span data-bind="user.name__html:value"></span>
			</div>
		</div>
	</div>

	<div data---="console__common.consolewindow__datasource:common.console"></div>
	<div data---="importer__common.form__if:screenshot;url:/forms/screenshot.html"></div>
	<div data---="importer__common.form__if:status;url:/forms/status.html"></div>
	<div data---="importer__common.form__if:sessionsform;url:/forms/sessions.html"></div>

	<script>

		// For screenshots
		common.cdn = '@{'%cdn'}';
		common.cluster = '@{F.id}';
		common.livecounter = 0;
		common.liverefreshing = false;

		CACHEPATH('common.statusid', '12 hours');

		WATCH('common.consolewindow', function() {
			SET('common.consolecount', 0, 1000);
		});

		function togglemenu(value, path, el) {
			if (value) {
				el.rclass('hidden');
				setTimeout(function() {
					el.aclass('startmenu-visible');
					if (isMOBILE)
						SET('common.notifications', false);
					else
						$('.startmenu-search').find('input').focus();
					el.find('.noscrollbar').noscrollbar();
				}, 10);
			} else {
				el.rclass('startmenu-visible');
				setTimeout(function() {
					el.aclass('hidden');
				}, 300);
			}
		}

		$('body').on('click touchstart', function(e) {
			e.target.nodeName === 'BODY' && common.startmenu && TOGGLE('common.startmenu');
		});

		function mainmenu(el) {
			SET('common.startmenuapps', true);
			TOGGLE('common.startmenu');
		}

		WATCH('dashboard.apps', function() {
			EXEC('Dashboard/saveState');
		});

		WATCH('common.notifications', function(path, value) {
			value && refresh_notifications();
		});

		function refresh_notifications() {
			user.countnotifications && AJAX('GET /api/notifications/', function(arr) {
				SETTER('notifications', 'append', arr.take(50));
			});
			SET('user.countnotifications', 0);
		}

		function internalapp(el) {
			var id = typeof(el) === 'string' ? el : el.attrd('id');
			var iframe = dashboard.apps.findItem('id', id);
			if (iframe)
				SETTER('processes', 'maximize', id);
			else
				AJAX('GET /api/profile/{0}/'.format(id), FUNC.open);
			common.startmenu && SET('common.startmenu', false);
		}

		function internalreset() {
			common.startmenu && SET('common.startmenu', false);
			SETTER('processes', 'resetsize');
		}

		function internallogoff() {
			SETTER('loading', 'show');
			SETTER('processes', 'kill');
			setTimeout(function() {
				location.href = '/logoff/';
			}, 1000);
		}

		ON('message', function(message) {
			switch (message.TYPE) {
				case 'logoff':
					COOKIES.set('@{'%cookie'}', '', '-1 day');
					location.href = '/';
					break;
				case 'settings':
					document.title = message.body.name;
					SET('user.test', message.body.test === true);
					break;
			}
		});

		var LOADINGSKIP = true;

		ON('online', function(is) {
			if (LOADINGSKIP)
				LOADINGSKIP = false;
			else
				SETTER('loading', is ? 'hide' : 'show');
		});

		$(document).on('dblclick', '.appprocess', function() {
			if (user.sa) {
				var id = $(this).attrd('id');
				setTimeout(function() {
					SETTER('processes', 'reload', id);
				}, 500);
			}
		});

		var dashboard = {};

		dashboard.current = null;
		dashboard.apps = [];

		$(document).on('click', '.app', function() {
			var el = $(this);

			if (el.hclass('app-offline') || el.hclass('app-disabled'))
				return;

			var id = el.attr('data-id');
			var iframe = dashboard.apps.findItem('id', id);
			if (iframe)
				SETTER('processes', 'maximize', id);
			else
				AJAX('GET /api/profile/{0}/'.format(id), FUNC.open);

			common.startmenu && SET('common.startmenu', false);
		});

		PLUGIN('Dashboard', function(self) {

			self.hidemenu = function() {
				SET('common.startmenu', false);
			};

			self.showconsole = function() {
				TOGGLE('common.consolewindow');
			};

			self.showprofile = function() {
				internalapp('_account');
			};

			self.showsessions = function() {
				SET('common.form', 'sessionsform');
				SET('common.startmenu', false);
			};

			self.resizeapps = function() {
				var el = this.element;
				setTimeout2(this.ID, function() {
					el.css('width', el.find('button').length * 52);
					var parent = el.parent().parent();
					parent.css('width', WW - (80 + (WIDTH() === 'xs' ? 120 : 220)));
				}, 100, el);
			};

			self.open = function(el) {
				if (common.page !== 'dashboard')
					SET('common.page', 'dashboard');
				self.hidemenu();
				var id = el.attrd('id');
				SETTER('processes', 'maximize', id);
			};

			self.close = function(el, e) {
				e.stopPropagation();
				e.preventDefault();
				self.hidemenu();
				SETTER('processes', 'kill', el.attrd('id'));
			};

			self.navigate = function(el) {

				var id = el.attrd('id');
				var data = decodeURIComponent(el.attrd('data'));

				var app = user.apps.findItem('id', id);
				if (!app)
					return;

				var iframe = dashboard.apps.findItem('id', app.id);
				if (iframe) {
					SETTER('processes', 'sendnotifydata', app.id, data);
				} else {
					app.notifydata = data;
					AJAX('GET /api/profile/{0}/'.format(app.id), { href: app.url }, FUNC.open);
				}
			};

			self.sync = function() {
				var is = false;
				dashboard.apps = dashboard.apps.remove(function(item) {
					var app = user.apps.findItem('id', item.id);
					var rem = app == null || !app.online;
					if (rem) {
						SETTER('processes', 'kill', item.id);
						is = true;
					} else {
						//app.internal = app;
						//app.internal.running = item.running;
						app.running = item.running;
					}
					return rem;
				});

				$('.appclose').each(function() {
					var el = $(this);
					el.tclass('hidden', dashboard.apps.findIndex('id', el.attrd('id')) === -1);
				});

				is && UPDATE('dashboard.apps');
			};

			self.saveState = function() {
				CACHE('running', dashboard.apps.map(FN('n => n.id')), '1 year');
			};

			self.showstatusform = function() {
				SET('common.form', 'status');
				self.hidemenu();
			};

			self.init = function() {
				self.init = null;
				var running = CACHE('running');
				if (running && running.length) {
					running.wait(function(id, next) {
						var app = user.apps.findItem('id', id);
						if (app) {
							var el = $('.app[data-id="{0}"]'.format(app.id));
							if (!el.length)
								el = $('.internal[data-id="{0}"]'.format(app.id));
							if (el.length) {
								internalapp(el);
								setTimeout(next, 800);
								return;
							}
						}
						next();
					});
				} else
					SET('common.startmenu', true, 500);
			};

			self.appmenu = function(opt, next, iframe) {

				opt.items = [];

				if (opt.appitems) {
					for (var i = 0; i < opt.appitems.length; i++)
						opt.items.push(opt.appitems[i]);
					opt.items.push('-');
				}

				opt.items.push({ name: common.muted[iframe.id] ? '<strong>@(Enable sounds)</strong>' : '@(Mute sounds)', icon: common.muted[iframe.id] ? 'volume-up red' : 'volume-mute', value: 'mutesounds' });
				opt.items.push({ name: iframe.meta.notifications ? '@(Mute notifications)' : '<strong>@(Enable notifications)</strong>', icon: (iframe.meta.notifications ? '!far fa-bell-slash' : 'bell red'), value: 'mutenotifications' });
				opt.items.push('-');
				opt.items.push({ name: '@(Print)', icon: 'print', value: 'print' });
				opt.items.push({ name: '@(Refresh)', icon: 'refresh', value: 'refresh' });

				if (!isMOBILE)
					opt.items.push({ name: '@(Reset size)', icon: '!far fa-window-restore', value: 'reset' });

				opt.items.push({ name: '@(Close application)', icon: 'times-circle red', value: 'close' });
				next();
			};

		});

		SETTER(true, 'shortcuts', 'register', 'F1', function() {
			var items = [];

			for (var i = 0; i < user.apps.length; i++) {
				var app = user.apps[i];
				items.push({ TYPE: 'app', id: app.id, name: app.title, icon: app.icon });
			}

			items.push({ name: '@(Reset windows)', icon: 'window-restore', TYPE: 'reset' });
			items.push({ name: '@(Sign out)', icon: 'power-off', TYPE: 'logoff' });

			SETTER('features', 'show', items, function(item) {
				switch (item.TYPE) {
					case 'app':
						internalapp($('.app[data-id="{0}"],.internal[data-id="{0}"]'.format(item.id)));
						break;
					case 'logoff':
						internallogoff();
						break;
					case 'reset':
						internalreset();
						break;
				}
			}, true);

		}, true);

		SETTER(true, 'shortcuts', 'register', 'alt+w,cmd+w,alt+F3', function(e) {

			if (dashboard.current) {
				SETTER('processes', 'kill', dashboard.current.id);
				dashboard.current = null;
			} else if (dashboard.apps.length)
				SETTER('processes', 'kill', dashboard.apps[0].id);

			e.preventDefault();
			e.stopPropagation();
		}, true);

		SETTER(true, 'shortcuts', 'register', 'alt+r,F5', function(e) {
			var id = $('.ui-process-focus').attrd('id');
			id && SETTER('processes', 'reload', id);
			e.preventDefault();
			e.stopPropagation();
		}, true);

		WATCH('common.focused', function(path, id) {
			var nav = $('header').find('nav');
			nav.find('button.focused').rclass('focused');
			nav.find('button[data-id="{0}"]'.format(id)).aclass('focused');
			if (!id) {
				common.statustimeout && clearTimeout(common.statustimeout);
				common.statustimeout = null;
				NULL('common.status');
			}
		});

		Thelpers.status = function(value, icon) {
			var str;
			switch (value) {
				case 1:
					str = 'spinner fa-spin status1"></i>@(Busy)';
					break;
				case 2:
					str = 'moon status2"></i>@(Do not disturb)';
					break;
				case 3:
					str = 'door-open status3"></i>@(Be right back)';
					break;
				case 4:
					str = 'brain status4"></i>@(Meeting)';
					break;
				case 5:
					str = 'car status5"></i>@(Business trip)';
					break;
				case 6:
					str = 'umbrella-beach status6"></i>@(Holiday)';
					break;
				case 7:
					str = 'heartbeat status7"></i>@(Sick)';
					break;
				case 8:
					str = 'home status8"></i>@(Off work)';
					break;
				default:
					str = 'smile status0"></i>@(Available)';
					break;
			}

			var index = str.indexOf('</i>');
			var title = str.substring(index + 4);

			return '<i title="' + title + '" class="fa fa-' + (icon ? str.substring(0, index + 4) : str);
		};

		ON('response', function(response) {
			// unauthorized
			if (response.status === 401) {
				location.href = '/';
				response.cancel = true;
				return;
			}
		});

		function refresh_color(user) {
			CSS('.userbg,.user{background-color:{0}}.usercolor{color:{0}}{1}'.format(user.colorscheme || '#4285f4', user.background ? ('body{background:url(/backgrounds/' + user.background + ') 50% 50% !important;background-size:cover !important;}') : ''), 'usertheme');
			var b = $(document.body);
			b.tclass('light', !user.darkmode);
			b.tclass('ui-dark', !!user.darkmode);
			SETTER('processes', 'emitevent', 'appearance', { darkmode: user.darkmode, colorscheme: user.colorscheme, background: user.background ? (location.protocol + '//' + location.hostname + (location.port ? (':' + location.port) : '') + '/backgrounds/' + user.background) : '' });
		}

		function refresh_profiledata() {

			if (common.liverefreshing)
				return;

			common.liverefreshing = true;
			AJAX('GET /api/profile/live', function(response) {

				common.liverefreshing = false;

				if (response == null) {
					// maybe blocked
					location.reload(true);
					return;
				}

				var isui = user.darkmode !== response.darkmode || user.colorscheme !== response.colorscheme || user.background !== response.background;
				if (isui) {
					user.darkmode = response.darkmode;
					user.colorscheme = response.colorscheme;
					user.background = response.background;
					refresh_color(user);
				}

				var is = false;

				if (user.name !== response.name) {
					is = true;
					user.name = response.name;
				}

				if (user.photo !== response.photo) {
					is = true;
					user.photo = response.photo;
				}

				if (user.test !== response.test) {
					is = true;
					user.test = response.test;
				}

				if (user.volume !== response.volume) {
					is = true;
					user.volume = response.value;
				}

				if (user.countnotifications !== response.countnotifications) {
					is = true;
					user.countnotifications = response.countnotifications;
					user.countnotifications && user.sounds && SETTER('audio', 'play', '/sounds/notifications.mp3');
					common.notifications && refresh_notifications();
				}

				if (user.statusid !== response.statusid || user.status !== response.status) {
					is = true;
					user.statusid = response.statusid;
					user.status = response.status;
				}

				if (user.sa !== response.sa) {
					is = true;
					user.sa = response.sa;
				}

				var keys = [];

				for (var i = 0; i < user.apps.length; i++) {
					var app = user.apps[i];
					var ua = response.apps[app.id];

					if (app.id.charAt(0) !== '_')
						keys.push(app.id);

					if (ua == null)
						continue;

					if (app.countnotifications !== ua.countnotifications) {
						app.countnotifications = ua.countnotifications;
						is = true;
					}

					if (app.countbadges !== ua.countbadges) {
						app.countbadges = ua.countbadges;
						app.countbadges && user.sounds && SETTER('audio', 'play', '/sounds/badges.mp3');
						is = true;
					}

					if (app.notifications != null && ua.notifications != null && app.notifications !== ua.notifications) {
						app.notifications = ua.notifications;
						is = true;
					}
				}

				var keysnew = Object.keys(response.apps);

				keys.sort();
				keysnew.sort();

				if (keys.join('') !== keysnew.join(''))
					refresh_profile();
				else if (is)
					UPD('user');
			});
		}

		function refresh_profile() {
			AJAX('GET /api/profile/', function(profile) {

				if (profile == null) {
					// refresh (maybe blocked)
					location.reload(true);
					return;
				}

				profile.apps.quicksort('title');
				SET('user', profile);
				refresh_color(user);
				EXEC('Dashboard/sync');
				EXEC('Dashboard/init');
				SET('common.startmenusearch', '');
			});
		}

		setTimeout(refresh_profile, 1000);

		setInterval(function() {
			common.livecounter++;
 			if (common.livecounter % 24 === 0)
				refresh_profile();
			if (document.hasFocus())
				refresh_profiledata();
			else if (common.livecounter % 5 === 0)
				refresh_profiledata();

			if (common.livecounter > 99999999)
				common.livecounter = 0;

		}, 5000);

		function renderstatus(value, path, el) {
			if (value && !value.status) {
				value.status = 1;
				common.statustimeout && clearTimeout(common.statustimeout);
				el.tclass('green', value.type === 'success');
				el.tclass('orange', value.type === 'warning');
				el.tclass('red', value.type === 'error');
				el.tclass('blue', value.type === 'info');
				el.html(Thelpers.markdown_status(value));
				el.attr('title', el.text());
				common.statustimeout = setTimeout(function() {
					common.statustimeout = null;
					el.empty();
				}, 10000);
			} else
				el.empty();
		}

		Thelpers.time2 = function(value) {

			if (!value)
				return value;

			var diff = Date.now() - (value instanceof Date ? value : value.parseDate()).getTime();

			var minutes = Math.ceil((diff / 1000) / 60);
			if (minutes < 60) {
				if (minutes <= 1)
					return 'now';
				return minutes + ' minutes ago';
			}

			var hours = (minutes / 60) >> 0;
			if (hours < 24)
				return hours + ' ' + Thelpers.pluralize(hours, 'hours', 'hour', 'hours', 'hours') + ' ago';

			var days = (hours / 24) >> 0;
			if (days < 30)
				return days + ' ' + Thelpers.pluralize(days, 'days', 'day', 'days', 'days') + ' ago';

			var months = (days / 29) >> 0;
			if (months < 12)
				return months + ' ' + Thelpers.pluralize(months, 'months', 'month', 'months', 'months') + ' ago';

			var years = (months / 12) >> 0;
			return years + ' ' + Thelpers.pluralize(years, 'years', 'year', 'years', 'years') + ' ago';
		};

		Thelpers.time = function(value) {
			return value ? '<span class="ta-time" data-time="{0}" title="{2}">{1}</span>'.format(value.getTime(), Thelpers.time2(value), value.format(null)) : value;
		};

	</script>

	@{components('openplatform')}

</body>
</html>
