var OP={},OPENPLATFORM=OP;OP.version='3.0.0',OP.callbacks={},OP.events={},OP.is=top!==window,OP.pending=[],OP.interval=setInterval(function(){OP.ready&&(clearInterval(OP.interval),OP.pending.forEach(OP.$process))},500),document.onkeydown=function(n){116===n.keyCode&&(n.returnValue=!1,n.keyCode=0,-1===location.href.indexOf('openplatform=')?location.href=OP.tokenizator(location.href):location.reload(!0))},OP.screenshot=function(n){if(!OP.$screenshot){var e;window.Promise||((e=document.createElement('script')).type='text/javascript',e.src=(n||'//cdnjs.cloudflare.com/ajax/libs/babel-polyfill/6.26.0')+'/polyfill.min.js',document.body.appendChild(e)),(e=document.createElement('script')).type='text/javascript',e.src=(n||'//html2canvas.hertzen.com/dist')+'/html2canvas.min.js',document.body.appendChild(e),OP.$screenshot=1}var t=function(){OP.loading(!0),html2canvas(document.body).then(function(n){OP.send('screenshot',n.toDataURL('image/jpeg',.85)),OP.loading(!1)})},o=setInterval(function(){window.html2canvas&&(clearInterval(o),t())},1e3)},OP.launched=function(n){OP.send('launched',null,n)},OP.progress=function(n){return OP.send('progress',n)},OP.init=function(n){if(OP.ready=!1,n||(n=function(n){null!=n?(document.body.innerHTML='401: Unauthorized',setTimeout(function(){window.close()},2e3)):OP.ready=!0}),!OP.is)return n(new Error('OpenPlatform isn\'t detected.')),void(document.body.innerHTML='401: Unauthorized');for(var e=location.search.substring(1).split('&'),t=null,o=0,r=e.length;o<r;o++){var a=e[o];if('openplatform='===a.substring(0,13)){var i=decodeURIComponent(a.substring(13));OP.token=a.substring(13),t=decodeURIComponent(i.substring(i.indexOf('accesstoken=')+12));break}}var s={};s.ua=navigator.userAgent,OP.accesstoken=t;var c=setTimeout(function(){c=null,n('timeout'),document.body.innerHTML='401: Unauthorized'},2e3);OP.send('verify',s,function(e,t){c&&(clearTimeout(c),OP.ready=!e,n(null,t,setTimeout(function(){t.href&&(location.href=t.href)},100))),c=null})},document.addEventListener('click',function(){OP&&OP.focus()}),OP.loading=function(n,e){OP.$loading&&clearTimeout(OP.$loading),e?OP.$loading=setTimeout(function(n){OP.send('loading',n)},e,n):OP.send('loading',n)},OP.success=function(n,e){return OP.snackbar(n,'success',e)},OP.warning=function(n,e){return OP.snackbar(n,'warning',e)},OP.message=function(n,e,t){var o={};return o.body=n,o.type=e,o.button=t,OP.send('message',o)},OP.confirm=function(n,e,t){var o={};return o.body=n,o.buttons=e,OP.send('confirm',o,function(n,e){t(e?e.index:-1)})},OP.snackbar=function(n,e,t){var o={};return o.body=n,o.type=e,o.button=t,OP.send('snackbar',o,t)},OP.meta=function(n){var e={};e.ua=navigator.userAgent,e.accesstoken=OP.accesstoken,OP.send('meta',e,function(e,t){n(e,t)})},OP.play=function(n){return/^(http|https):\/\//.test(n)||('/'!==n.substring(0,1)&&(n='/'+n),n=location.protocol+'//'+location.hostname+n),OP.send('play',n)},OP.stop=function(n){return OP.send('stop',n)},OP.focus=function(){return OP.send('focus')},OP.maximize=function(n){return OP.send('maximize',n)},OP.restart=function(){return OP.send('restart',location.href)},OP.open=function(n,e){return OP.send('open',{id:n,data:e})},OP.minimize=function(){return OP.send('minimize')},OP.badge=function(){return OP.send('badge')},OP.log=function(n){return OP.send('log',n)},OP.close=function(){return OP.send('kill')},OP.notify=function(n,e,t){return'string'==typeof n&&(t=e,e=n,n=0),OP.send('notify',{type:n,body:e,data:t||'',datecreated:new Date})},OP.share=function(n,e,t){return OP.send('share',{app:'object'==typeof n?n.id:n,type:e,body:t,datecreated:new Date})},OP.email=function(n,e){return OP.send('email',{subject:n,body:e,datecreated:new Date})},OP.send=function(n,e,t){'function'==typeof e&&(t=e,e=null);var o={};if(o.openplatform=!0,o.accesstoken=OP.accesstoken,o.type=n,o.body=e||null,o.sender=!0,o.origin=location.protocol+'//'+location.hostname,top)return t&&(o.callback=(1e6*Math.random()).toString(32).replace(/\./g,''),OP.callbacks[o.callback]=t),top.postMessage(JSON.stringify(o),'*'),OP;t&&t(new Error('The application is not running in the OpenPlatform scope.'))},OP.on=function(n,e){return!OP.events[n]&&(OP.events[n]=[]),OP.events[n].push(e),OP},OP.$process=function(n){if(n.callback){var e=OP.callbacks[n.callback];e&&(n.sender&&(n.error=new Error('The application is not running in the OpenPlatform scope.')),e(n.error,n.body||{}),delete OP.callbacks[n.callback])}else if(!n.sender)if('reload'!==n.type)if('screenshotmake'!==n.type)if('redirect'!==n.type){'kill'===n.type&&(n.type='close'),'share'===n.type&&(n.body.share=function(n,e){OP.share(this.app,n,e)});var t=OP.events[n.type];t&&t.forEach(function(e){e(n.body||{})})}else location.href=n.body;else OP.screenshot(n.body);else-1===location.href.indexOf('openplatform=')?location.href=OP.tokenizator(location.href):location.reload(!0)},window.addEventListener('message',function(n){try{var e=JSON.parse(n.data);if(!e.openplatform)return;OP.ready||'verify'===e.type?OP.$process(e):OP.pending.push(e)}catch(n){}},!1),OP.tokenizator=function(n){var e=n.indexOf('?');return-1===e?n+'?openplatform='+OP.token:n.substring(0,e+1)+'openplatform='+OP.token+'&'+n.substring(e+1)},window.history&&(history.pushState(null,null,location.href),window.onpopstate=function(){history.go(1)});